varnishtest "Read a binary file"

shell {
	printf 'blob\000' >blob.bin
}

varnish v1 -vcl {
	import std;
	backend be none;
	sub vcl_recv {
		return (synth(200));
	}
	sub vcl_synth {
		if (req.url ~ "string") {
			set resp.body = std.fileread("${tmpdir}/blob.bin");
		}
		if (req.url ~ "blob") {
			set resp.body = std.blobread("${tmpdir}/blob.bin");
		}
		return (deliver);
	}
} -start

client c1 {
	txreq -url "/string"
	rxresp
	expect resp.status == 200
	expect resp.bodylen == 4

	txreq -url "/blob"
	rxresp
	expect resp.status == 200
	expect resp.bodylen == 5
} -run
